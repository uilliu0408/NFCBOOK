<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NFC ë…ì„œê¸°ë¡ì¥</title>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCwf8YefXWjheKg5SYjWUqA0khJu37pMGk",
      authDomain: "chat-38c87.firebaseapp.com",
      projectId: "chat-38c87",
      storageBucket: "chat-38c87.firebasestorage.app",
      messagingSenderId: "173428820608",
      appId: "1:173428820608:web:e89fb8d19cc4e35c253465",
      measurementId: "G-5340BFY1RL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;
    window.firestoreDoc = doc;
    window.firestoreGet = getDoc;
    window.firestoreSet = setDoc;
    window.firestoreUpdate = updateDoc;
  </script>

  <!-- ìŠ¤íƒ€ì¼ -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;600&display=swap');

    body {
      font-family: 'Noto Serif KR', serif;
      background: url('/mnt/data/c456d308-8048-4503-ad42-e49790160a08.png') 
                  no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      color: #ffffff;
      position: relative;
      overflow-x: hidden;
    }

    /* ëˆˆ ë‚´ë¦¬ëŠ” íš¨ê³¼ */
    .snow {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
      background-image: 
        radial-gradient(white 1px, transparent 1px),
        radial-gradient(white 1px, transparent 1px),
        radial-gradient(white 1px, transparent 1px);
      background-size: 3px 3px, 4px 4px, 5px 5px;
      background-position: 0 0, 50px 100px, 100px 50px;
      animation: snowfall 12s linear infinite;
    }

    @keyframes snowfall {
      0% { background-position: 0 0, 50px 100px, 100px 50px; }
      100% { background-position: 0 1000px, 50px 1100px, 100px 1150px; }
    }

    header {
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(6px);
      padding: 1.2rem;
      text-align: center;
      font-size: 1.4rem;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    main {
      padding: 1.5rem;
      max-width: 820px;
      margin: auto;
      position: relative;
      z-index: 20; /* ëˆˆë³´ë‹¤ ìœ„ì— */
    }

    .box {
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
      border-radius: 14px;
      padding: 1.5rem;
      margin-bottom: 1.4rem;
      box-shadow: 0 4px 25px rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.25);
      color: #fff;
    }

    input, textarea, button, select {
      width: 100%;
      margin: 0.7rem auto;
      padding: 0.75rem;
      border-radius: 8px;
      border: none;
      background-color: rgba(255,255,255,0.85);
      color: #2e2e2e;
      font-size: 1rem;
    }

    button {
      background-color: #d8c7a6;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }
    button:hover {
      background-color: #c7b28b;
    }

    img {
      border-radius: 10px;
      max-width: 100%;
      box-shadow: 0 3px 12px rgba(0,0,0,0.4);
      cursor: pointer;
    }
  </style>

</head>
<body>
  <div class="snow"></div>

  <header>
    <h1>ğŸ„ ë”°ëœ»í•œ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ë…ì„œê¸°ë¡ì¥ ğŸ</h1>
  </header>

  <main>
    <div class="box" id="passwordSection">
      <label>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ìƒˆë¡œ ë§Œë“¤ì–´ì£¼ì„¸ìš”.</label>
      <input type="password" id="password" maxlength="4" />
      <button onclick="checkPassword()">ì ‘ì†</button>
      <p id="passMsg" style="color:#ffdddd;"></p>
    </div>

    <div id="bookForm" class="box" style="display:none;">
      <label>ì±… ì œëª©</label><input id="title" type="text" />
      <label>ì‘ê°€</label><input id="author" type="text" />
      <label>ì½ì€ ë‚ ì§œ</label><input id="date" type="date" />
      <label>ì½ì€ í˜ì´ì§€</label><input id="pages" type="text" />
      <label>ì±… ë‚´ìš© ìš”ì•½</label><textarea id="summary"></textarea>
      <label>ì¸ìƒ ê¹Šì€ ë¬¸ì¥</label><textarea id="quote"></textarea>
      <label>ì±… ê´€ë ¨ ì‚¬ì§„</label><input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)" />
      <label>ë³„ì </label>
      <select id="rating">
        <option value="â­ï¸">â­ï¸</option>
        <option value="â­ï¸â­ï¸">â­ï¸â­ï¸</option>
        <option value="â­ï¸â­ï¸â­ï¸">â­ï¸â­ï¸â­ï¸</option>
        <option value="â­ï¸â­ï¸â­ï¸â­ï¸">â­ï¸â­ï¸â­ï¸â­ï¸</option>
        <option value="â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸">â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸</option>
      </select>
      <button onclick="saveEntry()">ê¸°ë¡ ì €ì¥</button>
      <button onclick="toggleTrash()">íœ´ì§€í†µ ë³´ê¸°</button>
      <button onclick="toggleChangePassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
    </div>

    <div id="changePasswordSection" class="box" style="display:none;">
      <label>ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="oldPassword" maxlength="4"/>
      <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="newPassword" maxlength="4"/>
      <button onclick="changePassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
      <p id="changeMessage" style="color:#ffdddd;"></p>
    </div>

    <div id="trashBin" class="box" style="display:none;">
      <h3>ğŸ—‘ï¸ íœ´ì§€í†µ</h3>
      <div id="trashEntries"></div>
      <button onclick="clearTrash()">íœ´ì§€í†µ ë¹„ìš°ê¸°</button>
    </div>

    <div id="entries"></div>
  </main>

  <!-- ê¸°ì¡´ ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸ ê·¸ëŒ€ë¡œ ìœ ì§€ -->
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get("id") || "default";

    const passKey = `password_${roomId}`;

    const checkPassword = () => {
      const input = document.getElementById("password").value;
      const stored = localStorage.getItem(passKey);
      if (!stored) {
        localStorage.setItem(passKey, input);
        showMain();
      } else if (input === stored) {
        showMain();
      } else {
        document.getElementById("passMsg").textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      }
    };

    const showMain = () => {
      document.getElementById("passwordSection").style.display = "none";
      document.getElementById("bookForm").style.display = "block";
      displayEntries();
      displayTrash();
    };

    let uploadedImageBase64 = "";

    const handleImageUpload = (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const maxWidth = 800;
          const scale = maxWidth / img.width;
          canvas.width = maxWidth;
          canvas.height = img.height * scale;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          uploadedImageBase64 = canvas.toDataURL("image/jpeg", 0.7);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    };

    const saveEntry = async () => {
      const entry = {
        title: title.value,
        author: author.value,
        date: date.value,
        pages: pages.value,
        summary: summary.value,
        quote: quote.value,
        rating: rating.value,
        image: uploadedImageBase64
      };

      const roomRef = firestoreDoc(db, "rooms", roomId);
      const docSnap = await firestoreGet(roomRef);
      let entries = docSnap.exists() ? (docSnap.data().entries || []) : [];

      entries.push(entry);

      await firestoreSet(roomRef, { entries }, { merge: true });
      alert("ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
      displayEntries();
    };

    const displayEntries = async () => {
      const roomRef = firestoreDoc(db, "rooms", roomId);
      const docSnap = await firestoreGet(roomRef);

      if (!docSnap.exists()) return;

      const entries = docSnap.data().entries || [];
      const div = document.getElementById("entries");
      div.innerHTML = "";

      entries.slice().reverse().forEach((entry, i, arr) => {
        const idx = arr.length - 1 - i;
        div.innerHTML += `
          <div class="box entry">
            <h3>${entry.title} - ${entry.author}</h3>
            <p><strong>ë‚ ì§œ:</strong> ${entry.date}</p>
            <p><strong>í˜ì´ì§€:</strong> ${entry.pages}</p>
            <p><strong>ìš”ì•½:</strong> ${entry.summary}</p>
            <p><strong>ì¸ìƒ ê¹Šì€ ë¬¸ì¥:</strong> "${entry.quote}"</p>
            <p><strong>ë³„ì :</strong> ${entry.rating}</p>
            ${entry.image ? `<img src="${entry.image}" onclick='openModal("${entry.image}")'>` : ""}
            <button onclick="confirmDelete(${idx})">ì‚­ì œ</button>
          </div>`;
      });
    };

    const displayTrash = async () => {
      const roomRef = firestoreDoc(db, "rooms", roomId);
      const docSnap = await firestoreGet(roomRef);

      if (!docSnap.exists()) return;

      const trash = docSnap.data().trash || [];
      const div = document.getElementById("trashEntries");
      div.innerHTML = "";

      trash.slice().reverse().forEach((entry, i, arr) => {
        const idx = arr.length - 1 - i;
        div.innerHTML += `
          <div class="box trash-entry">
            <h4>${entry.title} - ${entry.author}</h4>
            <button onclick="restoreEntry(${idx})">ë³µêµ¬</button>
          </div>`;
      });
    };

    const confirmDelete = async (index) => {
      if (!confirm("íœ´ì§€í†µìœ¼ë¡œ ì´ë™í• ê¹Œìš”?")) return;

      const roomRef = firestoreDoc(db, "rooms", roomId);
      const docSnap = await firestoreGet(roomRef);

      let data = docSnap.data();
      let entries = data.entries || [];
      let trash = data.trash || [];

      const deleted = entries.splice(index, 1)[0];
      trash.push(deleted);

      await firestoreUpdate(roomRef, { entries, trash });

      displayEntries();
      displayTrash();
    };

    const restoreEntry = async (index) => {
      const roomRef = firestoreDoc(db, "rooms", roomId);
      const docSnap = await firestoreGet(roomRef);

      let data = docSnap.data();
      let entries = data.entries || [];
      let trash = data.trash || [];

      const restored = trash.splice(index, 1)[0];
      entries.push(restored);

      await firestoreUpdate(roomRef, { entries, trash });

      displayEntries();
      displayTrash();
    };

    const toggleTrash = () => {
      const bin = document.getElementById("trashBin");
      bin.style.display = bin.style.display === "block" ? "none" : "block";
    };
  </script>

</body>
</html>
