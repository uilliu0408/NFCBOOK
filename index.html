<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NFC ë…ì„œê¸°ë¡ì¥</title>
  <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyCwf8YefXWjheKg5SYjWUqA0khJu37pMGk",
    authDomain: "chat-38c87.firebaseapp.com",
    projectId: "chat-38c87",
    storageBucket: "chat-38c87.firebasestorage.app",
    messagingSenderId: "173428820608",
    appId: "1:173428820608:web:e89fb8d19cc4e35c253465",
    measurementId: "G-5340BFY1RL"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);

  const db = getFirestore(app);
window.db = db;
window.firestoreDoc = doc;
window.firestoreGet = getDoc;
window.firestoreSet = setDoc;
window.firestoreUpdate = updateDoc;
</script>
 <style>
@import url('https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700&family=Gowun+Batang:wght@400;700&display=swap');

body {
  margin: 0;
  padding: 0;
  font-family: 'Gowun Batang', serif;
  color: #fefefe;
  background: url('https://images.unsplash.com/photo-1608889175152-67f2adf9bb9a?auto=format&fit=crop&w=1600&q=80')
              no-repeat center center fixed;
  background-size: cover;
  overflow-x: hidden;
  position: relative;
}

/* âœ¨ ë”°ëœ»í•œ í™©ê¸ˆë¹› í•„í„° */
body::before {
  content: "";
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.35);
  backdrop-filter: blur(3px);
  z-index: 0;
  pointer-events: none;
}

/* â„ï¸ ëˆˆì†¡ì´ ì• ë‹ˆë©”ì´ì…˜ 1 (í° ëˆˆ) */
.snow-large {
  pointer-events: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-image: url("https://cdn-icons-png.flaticon.com/512/2315/2315357.png");
  background-size: 80px;
  opacity: 0.4;
  animation: snowfallLarge 12s linear infinite;
  z-index: 1;
}

@keyframes snowfallLarge {
  0% { transform: translateY(-100px); }
  100% { transform: translateY(100vh); }
}

/* â„ï¸ ëˆˆì†¡ì´ ì• ë‹ˆë©”ì´ì…˜ 2 (ì‘ì€ ëˆˆ) */
.snow-small {
  pointer-events: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background-image: url("https://cdn-icons-png.flaticon.com/512/616/616490.png");
  background-size: 25px;
  opacity: 0.6;
  animation: snowfallSmall 8s linear infinite;
  z-index: 2;
}

@keyframes snowfallSmall {
  0% { transform: translateY(-100px) translateX(0); }
  100% { transform: translateY(100vh) translateX(40px); }
}

/* ğŸ„ ìƒë‹¨ í—¤ë” */
header {
  position: relative;
  background: rgba(255,255,255,0.23);
  color: #fff9f2;
  text-shadow: 0 0 10px rgba(255,220,170,0.8);
  backdrop-filter: blur(8px);
  padding: 1.5rem 1rem;
  font-size: 1.6rem;
  letter-spacing: 2px;
  border-bottom: 1px solid rgba(255,255,255,0.3);
  z-index: 10;
}

/* ğŸ ë©”ì¸ ì»¨í…Œì´ë„ˆ */
main {
  max-width: 860px;
  margin: auto;
  padding: 1.5rem;
  position: relative;
  z-index: 10;
}

/* ğŸ„ ì•„ëŠ‘í•œ ì¹´ë“œ ë°•ìŠ¤ */
.box {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(12px);
  padding: 1.6rem;
  margin-bottom: 1.6rem;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.28);
  box-shadow:
    0 6px 18px rgba(0,0,0,0.35),
    0 0 18px rgba(255,210,150,0.4);
  animation: boxFade 0.45s ease;
}

@keyframes boxFade {
  from { opacity: 0; transform: translateY(14px); }
  to   { opacity: 1; transform: translateY(0);   }
}

/* ğŸ“˜ ì…ë ¥ ìš”ì†Œ */
input, textarea, select {
  width: 100%;
  padding: 0.75rem 1rem;
  margin-top: 0.8rem;
  font-size: 1rem;
  border-radius: 12px;
  border: none;
  outline: none;
  background: rgba(255,255,255,0.85);
  color: #333;
  box-shadow: 0 3px 12px rgba(0,0,0,0.18);
  font-family: 'Nanum Myeongjo', serif;
}

textarea {
  resize: vertical;
  min-height: 95px;
}

input::placeholder,
textarea::placeholder {
  color: #666;
}

/* ğŸ… ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
button {
  width: 100%;
  margin-top: 1rem;
  padding: 0.85rem;
  font-size: 1rem;
  font-weight: 600;
  border-radius: 12px;
  border: none;
  background: linear-gradient(135deg, #dfbd88, #caa26b);
  color: #3b2b1e;
  box-shadow:
    0 3px 12px rgba(0,0,0,0.35),
    inset 0 0 10px rgba(255,255,255,0.4);
  cursor: pointer;
  transition: 0.25s ease;
}

button:hover {
  transform: translateY(-2px);
  background: linear-gradient(135deg, #e8c894, #b48a52);
  box-shadow:
    0 6px 20px rgba(0,0,0,0.4),
    inset 0 0 14px rgba(255,255,255,0.45);
}

/* ğŸ ê°œë³„ ê¸°ë¡ */
.entry img {
  width: 100%;
  border-radius: 14px;
  margin-top: 0.6rem;
  box-shadow: 0 6px 20px rgba(0,0,0,0.5);
  cursor: pointer;
}

/* ìˆ¨ê¹€ ìš”ì†Œ */
#entries, #trashBin, #bookForm {
  display: none;
}

/* ëª¨ë‹¬ ì´ë¯¸ì§€ */
#imageModal img {
  border-radius: 16px;
  box-shadow: 0 0 35px rgba(255,230,200,0.45);
}


</style>


</head>
<body>
  <header>
    <h1>ğŸ—‚ï¸ NFC ë…ì„œê¸°ë¡ì¥</h1>
  </header>
  <main>
    <div class="box" id="passwordSection">
      <label>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ìƒˆë¡œ ë§Œë“¤ì–´ì£¼ì„¸ìš”.</label>
      <input type="password" id="password" maxlength="4" />
      <button onclick="checkPassword()">ì ‘ì†</button>
      <p id="passMsg" style="color:red;"></p>
    </div>

    <div id="bookForm" class="box">
      <label>ì±… ì œëª©</label><input id="title" type="text" />
      <label>ì‘ê°€</label><input id="author" type="text" />
      <label>ì½ì€ ë‚ ì§œ</label><input id="date" type="date" />
      <label>ì½ì€ í˜ì´ì§€</label><input id="pages" type="text" />
      <label>ì±… ë‚´ìš© ìš”ì•½</label><textarea id="summary"></textarea>
      <label>ì¸ìƒ ê¹Šì€ ë¬¸ì¥</label><textarea id="quote"></textarea>
      <label>ì±… ê´€ë ¨ ì‚¬ì§„</label>
      <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)" />
      <label>ë³„ì </label>
      <select id="rating">
        <option value="â­ï¸">â­ï¸</option><option value="â­ï¸â­ï¸">â­ï¸â­ï¸</option>
        <option value="â­ï¸â­ï¸â­ï¸">â­ï¸â­ï¸â­ï¸</option><option value="â­ï¸â­ï¸â­ï¸â­ï¸">â­ï¸â­ï¸â­ï¸â­ï¸</option>
        <option value="â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸">â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸</option>
      </select>
      <button onclick="saveEntry()">ê¸°ë¡ ì €ì¥</button>
      <button onclick="toggleTrash()">íœ´ì§€í†µ ë³´ê¸°</button>
      <button onclick="toggleChangePassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
    </div>

    <div id="changePasswordSection" class="box" style="display:none;">
      <label>ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="oldPassword" maxlength="4"/>
      <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="newPassword" maxlength="4"/>
      <button onclick="changePassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
      <p id="changeMessage" style="color:red;"></p>
    </div>

    <div id="trashBin" class="box">
      <h3>ğŸ—‘ï¸ íœ´ì§€í†µ</h3>
      <div id="trashEntries"></div>
      <button onclick="clearTrash()">íœ´ì§€í†µ ë¹„ìš°ê¸°</button>
    </div>

    <div id="entries"></div>
  </main>

  <div id="imageModal" onclick="closeModal()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
       background-color:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center;">
    <img id="modalImage" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
         max-width:95%; max-height:95%; box-shadow:0 0 30px rgba(255,255,255,0.5); border-radius:10px;" />
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get("id") || "default";
   const passKey = `password_${roomId}`;
const dataKey = `readingEntriesNFC_${roomId}`;
const trashKey = `trashEntries_${roomId}`;

    const checkPassword = () => {
      const input = document.getElementById("password").value;
      const stored = localStorage.getItem(passKey);
      if (!stored) {
        localStorage.setItem(passKey, input);
        showMain();
      } else if (input === stored) {
        showMain();
      } else {
        document.getElementById("passMsg").textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì´ë¯¸ ë“±ë¡ëœ ê³„ì •)";
      }
    };

    const showMain = () => {
      document.getElementById("passwordSection").style.display = "none";
      document.getElementById("bookForm").style.display = "block";
      displayEntries();
      displayTrash();
      document.getElementById("entries").style.display = "block";
    };

    const saveEntry = async () => {
  const entry = {
    title: document.getElementById("title").value,
    author: document.getElementById("author").value,
    date: document.getElementById("date").value,
    pages: document.getElementById("pages").value,
    summary: document.getElementById("summary").value,
    quote: document.getElementById("quote").value,
    rating: document.getElementById("rating").value,
    image: uploadedImageBase64
  };

  const roomRef = firestoreDoc(db, "rooms", roomId);
  const docSnap = await firestoreGet(roomRef);
  let entries = [];

  if (docSnap.exists()) {
    const data = docSnap.data();
    entries = data.entries || [];
  }

  entries.push(entry);

  await firestoreSet(roomRef, { entries: entries }, { merge: true });
  alert("ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
  displayEntries();
};


    const displayEntries = async () => {
  const roomRef = firestoreDoc(db, "rooms", roomId);
  const docSnap = await firestoreGet(roomRef);
  if (!docSnap.exists()) return;

  const data = docSnap.data();
  const entries = data.entries || [];

  const div = document.getElementById("entries");
  div.innerHTML = "";

  entries.slice().reverse().forEach((entry, i, arr) => {
    const trueIndex = arr.length - 1 - i;
    div.innerHTML += `
      <div class="entry box">
        <h3>${entry.title} - ${entry.author}</h3>
        <p><strong>ë‚ ì§œ:</strong> ${entry.date}</p>
        <p><strong>í˜ì´ì§€:</strong> ${entry.pages}</p>
        <p><strong>ìš”ì•½:</strong> ${entry.summary}</p>
        <p><strong>ì¸ìƒ ê¹Šì€ ë¬¸ì¥:</strong> "${entry.quote}"</p>
        <p><strong>ë³„ì :</strong> ${entry.rating}</p>
        ${entry.image ? `<img src="${entry.image}" style='max-width:100%;' onclick='openModal("${entry.image}")'/>` : ""}
        <button onclick="confirmDelete(${trueIndex})">ì‚­ì œ</button>
      </div>`;
  });
};




    const displayTrash = async () => {
  const roomRef = firestoreDoc(db, "rooms", roomId);
  const docSnap = await firestoreGet(roomRef);
  if (!docSnap.exists()) return;

  const data = docSnap.data();
  const trash = data.trash || [];

  const div = document.getElementById("trashEntries");
  div.innerHTML = "";
  trash.slice().reverse().forEach((entry, i, arr) => {
    const trueIndex = arr.length - 1 - i;
    div.innerHTML += `
      <div class="trash-entry box">
        <h4>${entry.title} - ${entry.author}</h4>
        <button onclick="restoreEntry(${trueIndex})">ë³µêµ¬</button>
      </div>`;
  });
};


    const confirmDelete = async (index) => {
  if (!confirm("íœ´ì§€í†µìœ¼ë¡œ ë³´ë‚¼ê¹Œìš”?")) return;

  const roomRef = firestoreDoc(db, "rooms", roomId);
  const docSnap = await firestoreGet(roomRef);
  if (docSnap.exists()) {
    let data = docSnap.data();
    let entries = data.entries || [];
    let trash = data.trash || [];

    const deleted = entries.splice(index, 1)[0]; // ì‚­ì œí•  í•­ëª©
    trash.push(deleted);

    await firestoreUpdate(roomRef, {
      entries: entries,
      trash: trash
    });

    displayEntries();
    displayTrash();
  }
};


    const restoreEntry = async (index) => {
  const roomRef = firestoreDoc(db, "rooms", roomId);
  const docSnap = await firestoreGet(roomRef);
  if (!docSnap.exists()) return;

  let data = docSnap.data();
  let entries = data.entries || [];
  let trash = data.trash || [];

  const restored = trash.splice(index, 1)[0]; // ë³µêµ¬í•  í•­ëª© êº¼ë‚´ê¸°
  entries.push(restored);

  await firestoreUpdate(roomRef, {
    entries: entries,
    trash: trash
  });

  displayEntries();
  displayTrash();
};


    const toggleTrash = () => {
      const bin = document.getElementById("trashBin");
      bin.style.display = bin.style.display === "block" ? "none" : "block";
      const entriesDiv = document.getElementById("entries");
      if (bin.style.display === "block") {
        entriesDiv.parentNode.insertBefore(bin, entriesDiv);
      }
    };

    const toggleChangePassword = () => {
      const section = document.getElementById("changePasswordSection");
      section.style.display = section.style.display === "block" ? "none" : "block";
    };

    const changePassword = () => {
      const oldPass = document.getElementById("oldPassword").value;
      const newPass = document.getElementById("newPassword").value;
      const storedPass = localStorage.getItem(passKey);
      if (oldPass === storedPass && newPass.length === 4) {
        localStorage.setItem(passKey, newPass);
        document.getElementById("changeMessage").textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.";
      } else {
        document.getElementById("changeMessage").textContent = "ì…ë ¥í•œ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      }
    };

    let uploadedImageBase64 = "";

    const handleImageUpload = (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const maxWidth = 800;
          const scale = maxWidth / img.width;
          canvas.width = maxWidth;
          canvas.height = img.height * scale;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          uploadedImageBase64 = canvas.toDataURL("image/jpeg", 0.7);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    };

    const openModal = (src) => {
      const modal = document.getElementById("imageModal");
      const img = document.getElementById("modalImage");
      img.src = src;
      modal.style.display = "flex";
    };

    const closeModal = () => {
      const modal = document.getElementById("imageModal");
      modal.style.display = "none";
      document.getElementById("modalImage").src = "";
    };

    const clearTrash = async () => {
  if (!confirm("íœ´ì§€í†µì„ ì™„ì „íˆ ë¹„ìš¸ê¹Œìš”?")) return;

  const roomRef = firestoreDoc(db, "rooms", roomId);
  await firestoreUpdate(roomRef, {
    trash: []
  });

  displayTrash();
};

  </script>
</body>
</html>



