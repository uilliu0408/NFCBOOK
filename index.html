<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NFC ë…ì„œê¸°ë¡ì¥</title>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCwf8YefXWjheKg5SYjWUqA0khJu37pMGk",
      authDomain: "chat-38c87.firebaseapp.com",
      projectId: "chat-38c87",
      storageBucket: "chat-38c87.firebasestorage.app",
      messagingSenderId: "173428820608",
      appId: "1:173428820608:web:e89fb8d19cc4e35c253465",
      measurementId: "G-5340BFY1RL"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    const db = getFirestore(app);
    window.db = db;
    window.firestoreDoc = doc;
    window.firestoreGet = getDoc;
    window.firestoreSet = setDoc;
    window.firestoreUpdate = updateDoc;
  </script>

  <!-- STYLE -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;600&display=swap');

    body {
      font-family: 'Noto Serif KR', serif;
      margin: 0;
      padding: 0;
      color: #ffffff;
      background: url('/mnt/data/06d832ad-a4bf-46a4-8899-bed542d949cc.png') no-repeat center center fixed;
      background-size: cover;
      position: relative;
      overflow-x: hidden;
    }

    /* ëˆˆ ì• ë‹ˆë©”ì´ì…˜ */
    .snow {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 2;
      animation: snowfall 10s linear infinite;
      background-image: url('https://i.imgur.com/NV7pQJf.png');
      background-size: contain;
      opacity: 0.5;
    }

    @keyframes snowfall {
      0% { transform: translateY(-100px); }
      100% { transform: translateY(100vh); }
    }

    header {
      text-align: center;
      padding: 1.5rem;
      font-size: 1.7rem;
      letter-spacing: 2px;
      font-weight: 600;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      color: #fff;
      position: relative;
      z-index: 3;
    }

    main {
      padding: 1.5rem;
      max-width: 820px;
      margin: auto;
      position: relative;
      z-index: 3;
    }

    .box {
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(14px);
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1.4rem;
      box-shadow: 0 4px 18px rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.25);
      color: #fff;
    }

    input, textarea, button, select {
      width: 100%;
      margin: 0.7rem auto;
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #dcdcdc;
      background-color: rgba(255,255,255,0.85);
      box-sizing: border-box;
      font-family: 'Noto Serif KR', serif;
      color: #333;
    }

    button {
      background-color: #d6b88d;
      color: #3a3a3a;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background-color: #c3a678;
    }

    img {
      border-radius: 12px;
      margin-top: 0.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.35);
      cursor: pointer;
      max-width: 100%;
    }

    #entries, #trashBin, #bookForm {
      display: none;
    }
  </style>

</head>
<body>

  <!-- ëˆˆ íš¨ê³¼ -->
  <div class="snow"></div>

  <header>
    ğŸ„ NFC ë…ì„œê¸°ë¡ì¥
  </header>

  <main>
    <div class="box" id="passwordSection">
      <label>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ìƒˆë¡œ ë§Œë“¤ì–´ì£¼ì„¸ìš”.</label>
      <input type="password" id="password" maxlength="4" />
      <button onclick="checkPassword()">ì ‘ì†</button>
      <p id="passMsg" style="color:#ffaaaa;"></p>
    </div>

    <div id="bookForm" class="box">
      <label>ì±… ì œëª©</label><input id="title" type="text" />
      <label>ì‘ê°€</label><input id="author" type="text" />
      <label>ì½ì€ ë‚ ì§œ</label><input id="date" type="date" />
      <label>ì½ì€ í˜ì´ì§€</label><input id="pages" type="text" />
      <label>ì±… ë‚´ìš© ìš”ì•½</label><textarea id="summary"></textarea>
      <label>ì¸ìƒ ê¹Šì€ ë¬¸ì¥</label><textarea id="quote"></textarea>
      <label>ì±… ê´€ë ¨ ì‚¬ì§„</label>
      <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)" />
      <label>ë³„ì </label>
      <select id="rating">
        <option>â­ï¸</option>
        <option>â­ï¸â­ï¸</option>
        <option>â­ï¸â­ï¸â­ï¸</option>
        <option>â­ï¸â­ï¸â­ï¸â­ï¸</option>
        <option>â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸</option>
      </select>

      <button onclick="saveEntry()">ê¸°ë¡ ì €ì¥</button>
      <button onclick="toggleTrash()">íœ´ì§€í†µ ë³´ê¸°</button>
      <button onclick="toggleChangePassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
    </div>

    <div id="changePasswordSection" class="box" style="display:none;">
      <label>ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="oldPassword" maxlength="4"/>
      <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="newPassword" maxlength="4"/>
      <button onclick="changePassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
      <p id="changeMessage" style="color:#ffaaaa;"></p>
    </div>

    <div id="trashBin" class="box">
      <h3>ğŸ—‘ï¸ íœ´ì§€í†µ</h3>
      <div id="trashEntries"></div>
      <button onclick="clearTrash()">íœ´ì§€í†µ ë¹„ìš°ê¸°</button>
    </div>

    <div id="entries"></div>

  </main>

  <!-- JS ê¸°ëŠ¥: ê·¸ëŒ€ë¡œ ìœ ì§€ -->
  <script>
    /* ê·¸ëŒ€ë¡œ ìœ ì§€ â€” ê¸°ëŠ¥ ì½”ë“œëŠ” ë³€í•¨ ì—†ìŒ */
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get("id") || "default";
    const passKey = `password_${roomId}`;

    const checkPassword = () => {
      const input = document.getElementById("password").value;
      const stored = localStorage.getItem(passKey);
      if (!stored) {
        localStorage.setItem(passKey, input);
        showMain();
      } else if (input === stored) {
        showMain();
      } else {
        document.getElementById("passMsg").textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      }
    };

    const showMain = () => {
      document.getElementById("passwordSection").style.display = "none";
      document.getElementById("bookForm").style.display = "block";
      document.getElementById("entries").style.display = "block";
      displayEntries();
      displayTrash();
    };

    let uploadedImageBase64 = "";

    const handleImageUpload = (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const maxWidth = 900;
          const scale = maxWidth / img.width;
          canvas.width = maxWidth;
          canvas.height = img.height * scale;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          uploadedImageBase64 = canvas.toDataURL("image/jpeg", 0.7);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    };

    const saveEntry = async () => {
      const entry = {
        title: title.value,
        author: author.value,
        date: date.value,
        pages: pages.value,
        summary: summary.value,
        quote: quote.value,
        rating: rating.value,
        image: uploadedImageBase64
      };

      const roomRef = firestoreDoc(db, "rooms", roomId);
      const snap = await firestoreGet(roomRef);
      let entries = snap.exists() ? snap.data().entries || [] : [];

      entries.push(entry);
      await firestoreSet(roomRef, { entries }, { merge: true });

      alert("ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
      displayEntries();
    };

    const displayEntries = async () => {
      const roomRef = firestoreDoc(db, "rooms", roomId);
      const snap = await firestoreGet(roomRef);
      if (!snap.exists()) return;
      const entries = snap.data().entries || [];

      const div = document.getElementById("entries");
      div.innerHTML = "";

      entries.slice().reverse().forEach((entry, i, arr) => {
        const idx = arr.length - 1 - i;
        div.innerHTML += `
          <div class="box entry">
            <h3>${entry.title} - ${entry.author}</h3>
            <p>ë‚ ì§œ: ${entry.date}</p>
            <p>í˜ì´ì§€: ${entry.pages}</p>
            <p>ìš”ì•½: ${entry.summary}</p>
            <p>"${entry.quote}"</p>
            <p>ë³„ì : ${entry.rating}</p>
            ${entry.image ? `<img src="${entry.image}" onclick='openModal("${entry.image}")'>` : ""}
            <button onclick="confirmDelete(${idx})">ì‚­ì œ</button>
          </div>
        `;
      });
    };

    const openModal = (src) => {
      const modal = document.getElementById("imageModal");
      const img = document.getElementById("modalImage");
      img.src = src;
      modal.style.display = "flex";
    };

    const closeModal = () => {
      document.getElementById("imageModal").style.display = "none";
    };

    const displayTrash = async () => {
      const roomRef = firestoreDoc(db, "rooms", roomId);
      const snap = await firestoreGet(roomRef);
      if (!snap.exists()) return;
      const trash = snap.data().trash || [];

      const div = document.getElementById("trashEntries");
      div.innerHTML = "";

      trash.slice().reverse().forEach((entry, i, arr) => {
        const idx = arr.length - 1 - i;
        div.innerHTML += `
          <div class="box trash-entry">
            <h4>${entry.title}</h4>
            <button onclick="restoreEntry(${idx})">ë³µêµ¬</button>
          </div>
        `;
      });
    };

    const confirmDelete = async (index) => {
      if (!confirm("íœ´ì§€í†µìœ¼ë¡œ ë³´ë‚¼ê¹Œìš”?")) return;
      const roomRef = firestoreDoc(db, "rooms", roomId);
      const snap = await firestoreGet(roomRef);
      if (!snap.exists()) return;

      const data = snap.data();
      let entries = data.entries || [];
      let trash = data.trash || [];
      trash.push(entries.splice(index,1)[0]);

      await firestoreUpdate(roomRef, { entries, trash });
      displayEntries();
      displayTrash();
    };

    const restoreEntry = async (index) => {
      const roomRef = firestoreDoc(db, "rooms", roomId);
      const snap = await firestoreGet(roomRef);
      if (!snap.exists()) return;

      let data = snap.data();
      let entries = data.entries || [];
      let trash = data.trash || [];

      entries.push(trash.splice(index,1)[0]);
      await firestoreUpdate(roomRef, { entries, trash });

      displayEntries();
      displayTrash();
    };

    const clearTrash = async () => {
      if (!confirm("íœ´ì§€í†µì„ ë¹„ìš¸ê¹Œìš”?")) return;
      const roomRef = firestoreDoc(db, "rooms", roomId);
      await firestoreUpdate(roomRef, { trash: [] });
      displayTrash();
    };
  </script>
</body>
</html>
