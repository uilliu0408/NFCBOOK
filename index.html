<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NFC 독서기록장</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+KR:wght@300;500&display=swap');

    body {
      font-family: 'Noto Sans KR', 'Orbitron', sans-serif;
      background: url('https://images.unsplash.com/photo-1477201389074-1863f668fac4?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 0;
      color: #ffffff;
    }

    header {
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 1rem;
      text-align: center;
      font-family: 'Orbitron', sans-serif;
      letter-spacing: 2px;
    }

    main {
      padding: 1rem;
      max-width: 800px;
      margin: auto;
    }

    .box {
      background: rgba(0, 0, 0, 0.6);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 10px rgba(255,255,255,0.1);
    }

    input, textarea, button, select {
      display: block;
      width: 96%;
      margin: 0.5rem auto;
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid #aaa;
      background-color: rgba(255,255,255,0.1);
      color: #fff;
      box-sizing: border-box;
    }

    input::placeholder, textarea::placeholder {
      color: #ccc;
    }

    button {
      background-color: #5c5be5;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 1rem;
      width: 96%;
      margin-left: auto;
      margin-right: auto;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #8d86f3;
    }

    #entries, #trashBin, #bookForm {
      display: none;
    }

    .entry, .trash-entry {
      margin-bottom: 1rem;
    }

    img {
      border-radius: 8px;
    }

    select {
      background-color: rgba(255,255,255,0.1);
      color: white;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCwf8YefXWjheKg5SYjWUqA0khJu37pMGk",
      authDomain: "chat-38c87.firebaseapp.com",
      projectId: "chat-38c87",
      storageBucket: "chat-38c87.appspot.com",
      messagingSenderId: "173428820608",
      appId: "1:173428820608:web:092fcf33b48b8268253465"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const roomId = new URLSearchParams(window.location.search).get("id") || "default";
    const docRef = doc(db, "rooms", roomId);
    let uploadedImageBase64 = "";

    const $ = (id) => document.getElementById(id);

    async function checkPassword() {
      const input = $("password").value;
      const snap = await getDoc(docRef);
      if (!snap.exists()) {
        await setDoc(docRef, { password: input, entries: [], trash: [] });
        showMain();
      } else {
        const saved = snap.data().password;
        if (input === saved) {
          showMain();
        } else {
          $("passMsg").textContent = "비밀번호가 일치하지 않습니다. (이미 등록된 계정)";
        }
      }
    }

    function showMain() {
      $("passwordSection").style.display = "none";
      $("bookForm").style.display = "block";
      $("entries").style.display = "block";
      displayEntries();
      displayTrash();
    }

    async function saveEntry() {
      const snap = await getDoc(docRef);
      const data = snap.data();
      const newEntry = {
        title: $("title").value,
        author: $("author").value,
        date: $("date").value,
        pages: $("pages").value,
        summary: $("summary").value,
        quote: $("quote").value,
        rating: $("rating").value,
        image: uploadedImageBase64
      };
      const updated = [...(data.entries || []), newEntry];
      await updateDoc(docRef, { entries: updated });
      alert("기록이 저장되었습니다!");
      displayEntries();
    }

    async function displayEntries() {
      const snap = await getDoc(docRef);
      const data = snap.data();
      const entries = (data.entries || []).slice().reverse();
      const div = $("entries");
      div.innerHTML = "";
      entries.forEach((entry, i) => {
        div.innerHTML += `<div class="entry box">
          <h3>${entry.title} - ${entry.author}</h3>
          <p><strong>날짜:</strong> ${entry.date}</p>
          <p><strong>페이지:</strong> ${entry.pages}</p>
          <p><strong>요약:</strong> ${entry.summary}</p>
          <p><strong>인상 깊은 문장:</strong> "${entry.quote}"</p>
          <p><strong>별점:</strong> ${entry.rating}</p>
          ${entry.image ? `<img src="${entry.image}" style='max-width:100%;' onclick='openModal("${entry.image}")'/>` : ""}
          <button onclick="confirmDelete(${data.entries.length - 1 - i})">삭제</button>
        </div>`;
      });
    }

    async function displayTrash() {
      const snap = await getDoc(docRef);
      const trash = (snap.data().trash || []).slice().reverse();
      const div = $("trashEntries");
      div.innerHTML = "";
      trash.forEach((entry, i) => {
        div.innerHTML += `<div class="trash-entry box">
          <h4>${entry.title} - ${entry.author}</h4>
          <button onclick="restoreEntry(${trash.length - 1 - i})">복구</button>
        </div>`;
      });
    }

    async function confirmDelete(index) {
      const snap = await getDoc(docRef);
      const data = snap.data();
      const entries = data.entries || [];
      const trash = data.trash || [];
      const removed = entries.splice(index, 1)[0];
      trash.push(removed);
      await updateDoc(docRef, { entries, trash });
      displayEntries();
      displayTrash();
    }

    async function restoreEntry(index) {
      const snap = await getDoc(docRef);
      const data = snap.data();
      const trash = data.trash || [];
      const entries = data.entries || [];
      const restored = trash.splice(index, 1)[0];
      entries.push(restored);
      await updateDoc(docRef, { entries, trash });
      displayEntries();
      displayTrash();
    }

    async function clearTrash() {
      await updateDoc(docRef, { trash: [] });
      displayTrash();
    }

    window.checkPassword = checkPassword;
    window.saveEntry = saveEntry;
    window.confirmDelete = confirmDelete;
    window.restoreEntry = restoreEntry;
    window.clearTrash = clearTrash;
    window.toggleTrash = () => {
      const bin = document.getElementById("trashBin");
      bin.style.display = bin.style.display === "block" ? "none" : "block";
      const entriesDiv = document.getElementById("entries");
      if (bin.style.display === "block") {
        entriesDiv.parentNode.insertBefore(bin, entriesDiv);
      }
    };
    window.toggleChangePassword = () => {
      const section = document.getElementById("changePasswordSection");
      section.style.display = section.style.display === "block" ? "none" : "block";
    };
    window.changePassword = async () => {
      const oldPass = document.getElementById("oldPassword").value;
      const newPass = document.getElementById("newPassword").value;
      const snap = await getDoc(docRef);
      if (snap.exists() && snap.data().password === oldPass && newPass.length === 4) {
        await updateDoc(docRef, { password: newPass });
        document.getElementById("changeMessage").textContent = "비밀번호가 변경되었습니다.";
      } else {
        document.getElementById("changeMessage").textContent = "입력한 정보가 올바르지 않습니다.";
      }
    };
    window.handleImageUpload = (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const maxWidth = 800;
          const scale = maxWidth / img.width;
          canvas.width = maxWidth;
          canvas.height = img.height * scale;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          uploadedImageBase64 = canvas.toDataURL("image/jpeg", 0.7);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    };
    window.openModal = (src) => {
      const modal = document.getElementById("imageModal");
      const img = document.getElementById("modalImage");
      img.src = src;
      modal.style.display = "flex";
    };
    window.closeModal = () => {
      const modal = document.getElementById("imageModal");
      modal.style.display = "none";
      document.getElementById("modalImage").src = "";
    };
  </script>
</head>
