<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NFC ë…ì„œê¸°ë¡ì¥ â€“ Christmas Edition</title>

  <!-- Firebase -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCwf8YefXWjheKg5SYjWUqA0khJu37pMGk",
    authDomain: "chat-38c87.firebaseapp.com",
    projectId: "chat-38c87",
    storageBucket: "chat-38c87.firebasestorage.app",
    messagingSenderId: "173428820608",
    appId: "1:173428820608:web:e89fb8d19cc4e35c253465",
    measurementId: "G-5340BFY1RL"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);

  const db = getFirestore(app);
  window.db = db;
  window.firestoreDoc = doc;
  window.firestoreGet = getDoc;
  window.firestoreSet = setDoc;
  window.firestoreUpdate = updateDoc;
  </script>

  <!-- í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ê³ ê¸‰ í…Œë§ˆ -->
  <style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;600&display=swap');

  body {
    font-family: 'Noto Serif KR', serif;
    background: url('https://images.unsplash.com/photo-1608889175123-58fe0da19a3d?auto=format&fit=crop&w=1600&q=80')
      no-repeat center center fixed;
    background-size: cover;
    margin: 0;
    padding: 0;
    color: #fff;
    overflow-x: hidden;
  }

  /* ì€ì€í•œ ì–´ë‘ìš´ ì˜¤ë²„ë ˆì´ (ê°€ë…ì„± ë†’ì„) */
  body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(2px);
    z-index: 0;
  }

  header {
    position: relative;
    z-index: 2;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(6px);
    padding: 1.2rem;
    text-align: center;
    font-size: 1.5rem;
    letter-spacing: 2px;
    color: #ffffff;
    border-bottom: 1px solid rgba(255,255,255,0.2);
    text-shadow: 0 0 10px rgba(255,255,255,0.25);
  }

  main {
    position: relative;
    z-index: 2;
    padding: 1.5rem;
    max-width: 830px;
    margin: auto;
  }

  .box {
    background: rgba(0,0,0,0.45);
    backdrop-filter: blur(12px);
    border-radius: 14px;
    padding: 1.4rem;
    margin-bottom: 1.4rem;
    box-shadow: 0 4px 18px rgba(0,0,0,0.35);
    border: 1px solid rgba(255,255,255,0.18);
    color: #fff;
  }

  input, textarea, button, select {
    width: 100%;
    margin: 0.7rem auto;
    padding: 0.75rem;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.3);
    background-color: rgba(255,255,255,0.12);
    color: #ffffff;
    box-sizing: border-box;
    font-family: 'Noto Serif KR', serif;
  }

  input::placeholder, textarea::placeholder {
    color: #dcdcdc;
  }

  textarea { resize: vertical; }

  button {
    background: linear-gradient(135deg, #ffecd2, #fcb69f);
    color: #3a2a1b;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: 0.25s;
  }

  button:hover {
    transform: translateY(-2px);
    background: linear-gradient(135deg, #ffe5c1, #fcb69f);
  }

  img {
    border-radius: 10px;
    margin-top: 0.5rem;
    box-shadow: 0 2px 14px rgba(0,0,0,0.4);
    cursor: pointer;
  }

  #entries, #trashBin, #bookForm {
    display: none;
  }

  /* â„ ëˆˆ ì• ë‹ˆë©”ì´ì…˜ */
  .snow {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1;
    background-image: url('https://i.ibb.co/yPKrFkw/snow2.png'),
                      url('https://i.ibb.co/yPKrFkw/snow2.png'),
                      url('https://i.ibb.co/yPKrFkw/snow2.png');
    animation: snow 10s linear infinite;
  }

  @keyframes snow {
    0% { background-position: 0px 0px, 0px -100px, 0px -200px; }
    100% { background-position: 0px 1000px, 0px 900px, 0px 800px; }
  }
  </style>
</head>

<body>
  <!-- ëˆˆ íš¨ê³¼ -->
  <div class="snow"></div>

  <header>
    ğŸ„ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ë…ì„œê¸°ë¡ì¥ ğŸ
  </header>

  <main>
    <!-- ë¹„ë°€ë²ˆí˜¸ -->
    <div class="box" id="passwordSection">
      <label>ë¹„ë°€ë²ˆí˜¸ (4ìë¦¬)</label>
      <input type="password" id="password" maxlength="4" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
      <button onclick="checkPassword()">ì ‘ì†</button>
      <p id="passMsg" style="color:#ffb3b3;"></p>
    </div>

    <!-- ê¸°ë¡ í¼ -->
    <div id="bookForm" class="box">
      <label>ì±… ì œëª©</label><input id="title" type="text" />
      <label>ì‘ê°€</label><input id="author" type="text" />
      <label>ì½ì€ ë‚ ì§œ</label><input id="date" type="date" />
      <label>ì½ì€ í˜ì´ì§€</label><input id="pages" type="text" />
      <label>ì±… ë‚´ìš© ìš”ì•½</label><textarea id="summary"></textarea>
      <label>ì¸ìƒ ê¹Šì€ ë¬¸ì¥</label><textarea id="quote"></textarea>
      <label>ì±… ì‚¬ì§„</label>
      <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)" />
      <label>ë³„ì </label>
      <select id="rating">
        <option value="â­ï¸">â­ï¸</option><option value="â­ï¸â­ï¸">â­ï¸â­ï¸</option>
        <option value="â­ï¸â­ï¸â­ï¸">â­ï¸â­ï¸â­ï¸</option><option value="â­ï¸â­ï¸â­ï¸â­ï¸">â­ï¸â­ï¸â­ï¸â­ï¸</option>
        <option value="â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸">â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸</option>
      </select>

      <button onclick="saveEntry()">ê¸°ë¡ ì €ì¥</button>
      <button onclick="toggleTrash()">íœ´ì§€í†µ ë³´ê¸°</button>
      <button onclick="toggleChangePassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
    </div>

    <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
    <div id="changePasswordSection" class="box" style="display:none;">
      <label>ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="oldPassword" maxlength="4"/>
      <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="newPassword" maxlength="4"/>
      <button onclick="changePassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
      <p id="changeMessage" style="color:#ffb3b3;"></p>
    </div>

    <!-- íœ´ì§€í†µ -->
    <div id="trashBin" class="box">
      <h3>ğŸ—‘ íœ´ì§€í†µ</h3>
      <div id="trashEntries"></div>
      <button onclick="clearTrash()">íœ´ì§€í†µ ë¹„ìš°ê¸°</button>
    </div>

    <!-- ê¸°ë¡ ë¦¬ìŠ¤íŠ¸ -->
    <div id="entries"></div>
  </main>

  <!-- ì‚¬ì§„ í™•ëŒ€ ëª¨ë‹¬ -->
  <div id="imageModal" onclick="closeModal()" 
       style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
       background-color:rgba(0,0,0,0.9); z-index:9999; justify-content:center; align-items:center;">
    <img id="modalImage" 
         style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%);
         max-width:95%; max-height:95%; box-shadow:0 0 30px rgba(255,255,255,0.5);" />
  </div>

  <!-- ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸ (ê¸°ì¡´ ê·¸ëŒ€ë¡œ) -->
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get("id") || "default";
    const passKey = `password_${roomId}`;

    const checkPassword = () => {
      const input = document.getElementById("password").value;
      const stored = localStorage.getItem(passKey);
      if (!stored) {
        localStorage.setItem(passKey, input);
        showMain();
      } else if (input === stored) {
        showMain();
      } else {
        document.getElementById("passMsg").textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      }
    };

    const showMain = () => {
      document.getElementById("passwordSection").style.display = "none";
      document.getElementById("bookForm").style.display = "block";
      displayEntries();
      displayTrash();
      document.getElementById("entries").style.display = "block";
    };

    let uploadedImageBase64 = "";

    const handleImageUpload = (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          const maxWidth = 800;
          const scale = maxWidth / img.width;
          canvas.width = maxWidth;
          canvas.height = img.height * scale;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          uploadedImageBase64 = canvas.toDataURL("image/jpeg", 0.7);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    };

    const saveEntry = async () => {
      const entry = {
        title: document.getElementById("title").value,
        author: document.getElementById("author").value,
        date: document.getElementById("date").value,
        pages: document.getElementById("pages").value,
        summary: document.getElementById("summary").value,
        quote: document.getElementById("quote").value,
        rating: document.getElementById("rating").value,
        image: uploadedImageBase64
      };

      const roomRef = firestoreDoc(db, "rooms", roomId);
      const docSnap = await firestoreGet(roomRef);
      let entries = [];
      if (docSnap.exists()) {
        entries = docSnap.data().entries || [];
      }
      entries.push(entry);

      await firestoreSet(roomRef, { entries: entries }, { merge: true });
      alert("ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
      displayEntries();
    };

    const displayEntries = async () => {
      const roomRef = firestoreDoc(db, "rooms", roomId);
      const docSnap = await firestoreGet(roomRef);
      if (!docSnap.exists()) return;
      const entries = docSnap.data().entries || [];

      const div = document.getElementById("entries");
      div.innerHTML = "";

      entries.slice().reverse().forEach((entry, i, arr) => {
        const trueIndex = arr.length - 1 - i;
        div.innerHTML += `
      <div class="entry box">
        <h3>${entry.title} - ${entry.author}</h3>
        <p><strong>ë‚ ì§œ:</strong> ${entry.date}</p>
        <p><strong>í˜ì´ì§€:</strong> ${entry.pages}</p>
        <p><strong>ìš”ì•½:</strong> ${entry.summary}</p>
        <p><strong>ì¸ìƒ ê¹Šì€ ë¬¸ì¥:</strong> "${entry.quote}"</p>
        <p><strong>ë³„ì :</strong> ${entry.rating}</p>
        ${entry.image ? `<img src="${entry.image}" style='max-width:100%;' onclick='openModal("${entry.image}")'/>` : ""}
        <button onclick="confirmDelete(${trueIndex})">ì‚­ì œ</button>
      </div>`;
      });
    };

    const displayTrash = async () => {
      const roomRef = firestoreDoc(db, "rooms", roomId);
      const docSnap = await firestoreGet(roomRef);
      if (!docSnap.exists()) return;
      const trash = docSnap.data().trash || [];

      const div = document.getElementById("trashEntries");
      div.innerHTML = "";
      trash.slice().reverse().forEach((entry, i, arr) => {
        const trueIndex = arr.length - 1 - i;
        div.innerHTML += `
      <div class="trash-entry box">
        <h4>${entry.title} - ${entry.author}</h4>
        <button onclick="restoreEntry(${trueIndex})">ë³µêµ¬</button>
      </div>`;
      });
    };

    const confirmDelete = async (index) => {
      if (!confirm("íœ´ì§€í†µìœ¼ë¡œ ë³´ë‚¼ê¹Œìš”?")) return;

      const roomRef = firestoreDoc(db, "rooms", roomId);
      const docSnap = await firestoreGet(roomRef);

      if (docSnap.exists()) {
        let data = docSnap.data();
        let entries = data.entries || [];
        let trash = data.trash || [];

        const deleted = entries.splice(index, 1)[0];
        trash.push(deleted);

        await firestoreUpdate(roomRef, {
          entries: entries,
          trash: trash
        });

        displayEntries();
        displayTrash();
      }
    };

    const restoreEntry = async (index) => {
      const roomRef = firestoreDoc(db, "rooms", roomId);
      const docSnap = await firestoreGet(roomRef);
      if (!docSnap.exists()) return;

      let data = docSnap.data();
      let entries = data.entries || [];
      let trash = data.trash || [];

      const restored = trash.splice(index, 1)[0];
      entries.push(restored);

      await firestoreUpdate(roomRef, {
        entries: entries,
        trash: trash
      });

      displayEntries();
      displayTrash();
    };

    const toggleTrash = () => {
      const bin = document.getElementById("trashBin");
      bin.style.display = bin.style.display === "block" ? "none" : "block";
      const entriesDiv = document.getElementById("entries");
      if (bin.style.display === "block") {
        entriesDiv.parentNode.insertBefore(bin, entriesDiv);
      }
    };

    const toggleChangePassword = () => {
      const section = document.getElementById("changePasswordSection");
      section.style.display = section.style.display === "block" ? "none" : "block";
    };

    const changePassword = () => {
      const oldPass = document.getElementById("oldPassword").value;
      const newPass = document.getElementById("newPassword").value;
      const storedPass = localStorage.getItem(passKey);
      if (oldPass === storedPass && newPass.length === 4) {
        localStorage.setItem(passKey, newPass);
        document.getElementById("changeMessage").textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.";
      } else {
        document.getElementById("changeMessage").textContent = "ì…ë ¥í•œ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      }
    };

    const openModal = (src) => {
      const modal = document.getElementById("imageModal");
      const img = document.getElementById("modalImage");
      img.src = src;
      modal.style.display = "flex";
    };

    const closeModal = () => {
      const modal = document.getElementById("imageModal");
      modal.style.display = "none";
      document.getElementById("modalImage").src = "";
    };

    const clearTrash = async () => {
      if (!confirm("íœ´ì§€í†µì„ ì™„ì „íˆ ë¹„ìš¸ê¹Œìš”?")) return;

      const roomRef = firestoreDoc(db, "rooms", roomId);
      await firestoreUpdate(roomRef, { trash: [] });

      displayTrash();
    };
  </script>

</body>
</html>
